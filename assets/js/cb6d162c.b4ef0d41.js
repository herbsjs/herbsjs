"use strict";(self.webpackChunkherbjs_website=self.webpackChunkherbjs_website||[]).push([[2516],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),d=p(n),h=r,g=d["".concat(l,".").concat(h)]||d[h]||c[h]||i;return n?a.createElement(g,s(s({ref:t},u),{},{components:n})):a.createElement(g,s({ref:t},u))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var p=2;p<i;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},77481:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={id:"migrations",title:"7. Migrations",sidebar_label:"7. Migrations",slug:"/tutorial/migrations"},s=void 0,o={unversionedId:"tutorial/migrations",id:"tutorial/migrations",title:"7. Migrations",description:"Migrations in Herbs",source:"@site/docs/tutorial/migrations.md",sourceDirName:"tutorial",slug:"/tutorial/migrations",permalink:"/docs/tutorial/migrations",draft:!1,editUrl:"https://github.com/herbsjs/herbsjs.github.io/blob/master/docs/tutorial/migrations.md",tags:[],version:"current",frontMatter:{id:"migrations",title:"7. Migrations",sidebar_label:"7. Migrations",slug:"/tutorial/migrations"},sidebar:"sidebar",previous:{title:"6. Repositories",permalink:"/docs/tutorial/repositories"},next:{title:"8. GraphQL & Rest",permalink:"/docs/tutorial/graphql-rest"}},l={},p=[{value:"Migrations in Herbs",id:"migrations-in-herbs",level:2},{value:"Setting up a database",id:"setting-up-a-database",level:3},{value:"Set up with PostgreSQL",id:"set-up-with-postgresql",level:3},{value:"KnexFile",id:"knexfile",level:4},{value:"Running migrations",id:"running-migrations",level:3},{value:"Next step",id:"next-step",level:3}],u={toc:p};function c(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"migrations-in-herbs"},"Migrations in Herbs"),(0,r.kt)("p",null,"Migrations, or rather database migrations, is a strategy for managing the changes that occur in an application's database throughout its life cycle. "),(0,r.kt)("p",null,"We won't go into the details of this approach here, just present that within ",(0,r.kt)("inlineCode",{parentName:"p"},"herbs")," you can use all the features that knex.js provides for dealing with database migrations."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Refer to ",(0,r.kt)("a",{parentName:"p",href:"http://knexjs.org/guide/migrations.html"},"Knex.js Migrations Guide")," to know more.")),(0,r.kt)("p",null,"A few steps back, a few times we execute the ",(0,r.kt)("inlineCode",{parentName:"p"},"herbs update")," command, and as we can see, ",(0,r.kt)("inlineCode",{parentName:"p"},"herbs-cli")," has created several files in our project based on our entities, the use cases, specs and repositories."),(0,r.kt)("p",null,"The migrations files are part of this set and you can see them in:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sh"},"src\n\u2514\u2500\u2500 infra\n    \u2514\u2500\u2500 data\n        \u2514\u2500\u2500 database\n            \u2514\u2500\u2500 migrations\n                \u251c\u2500\u2500 20220710004557_lists.js\n                \u2514\u2500\u2500 20220710005004_items.js\n")),(0,r.kt)("p",null,"Inside these files you will find the definitions that have created new or modified tables in the database. "),(0,r.kt)("p",null,"As an example, let's look at the schema that creates our list table and we can see that the same fields that we initially put in our List entity are being defined."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"exports.up = async function (knex) {\n    knex.schema.hasTable('lists')\n        .then(function (exists) {\n            if (exists) return\n            return knex.schema\n                .createTable('lists', function (table) {\n                    table.integer('id').primary()\n                    table.string('name')\n                    table.string('description')\n                    table.timestamps()\n                })\n        })\n}\n\nexports.down = function (knex) {\n    return knex.schema\n    .dropTableIfExists('lists')\n}\n\n")),(0,r.kt)("h3",{id:"setting-up-a-database"},"Setting up a database"),(0,r.kt)("p",null,"Now we are a few steps away from running our application and consuming its endpoints, but first we need to set up the connection to a database so that our data is saved and the application does its expected job."),(0,r.kt)("p",null,"For this tutorial we have chosen to use postgres as the database, but with herbs we can choose between ",(0,r.kt)("inlineCode",{parentName:"p"},"postgres"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"mysql"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"sqlserver")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"mongo"),". so the setup is slightly different for each one of them and in the next step will be exclusively for you to see how to set up other databases."),(0,r.kt)("h3",{id:"set-up-with-postgresql"},"Set up with PostgreSQL"),(0,r.kt)("p",null,"The configuration file is ",(0,r.kt)("inlineCode",{parentName:"p"},"src/infra/config/postgres.js"),". It looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// src/infra/config/postgres.js\nconst env = require('sugar-env')\nrequire('dotenv').config()\n\nmodule.exports = {\n  client: 'pg',\n  connection: {\n    host: '127.0.0.1',\n    user: 'postgres',\n    password: 'postgres',\n    database: 'todoApiDatabase'\n  }\n}\n")),(0,r.kt)("h4",{id:"knexfile"},"KnexFile"),(0,r.kt)("p",null,"Projects thats uses Postgres, MySQL or SQLServer use ",(0,r.kt)("a",{parentName:"p",href:"http://knexjs.org/"},"Knex.js")," under the hood, so in these settings we'll have a ",(0,r.kt)("inlineCode",{parentName:"p"},"knexFile.js")," in root of project. Make sure your database access credentials are matched in the ",(0,r.kt)("inlineCode",{parentName:"p"},"knexFile.js")," and in the appropriate configuration file founded in ",(0,r.kt)("inlineCode",{parentName:"p"},"src/infra/config/..."),"."),(0,r.kt)("p",null,"The file ",(0,r.kt)("inlineCode",{parentName:"p"},"knexFile.js")," it will should be like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"module.exports = {\n    development: {\n            client: 'postgresql',\n            connection: {\n            database: 'todoApiDatabase',\n            user: 'postgres',\n            password: 'postgres',\n            host: '127.0.0.1',\n            port: 5432\n        },\n        migrations: {\n            directory: './src/infra/data/database/migrations',\n            tableName: 'knex_migrations'\n        }\n    },\n    staging: {},\n    production: {}\n}\n")),(0,r.kt)("h3",{id:"running-migrations"},"Running migrations"),(0,r.kt)("p",null,"Now that we have set up the database connection and have a postgres instance running, let's run the command which will create our tables in the database."),(0,r.kt)("p",null,"run in your terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cmd"},"npm run knex:migrate\n")),(0,r.kt)("p",null,"when the execution finishes, we can access the postgres terminal and verify that in our database the tables have been created:"),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(99268).Z,width:"755",height:"307"})),(0,r.kt)("h3",{id:"next-step"},"Next step"),(0,r.kt)("p",null,"Now we have everything we need to run our application and start making requests, we will see in the next step how to run our application and make requests to the endpoints that herbs delivers to us through the Graphql and Rest layers"))}c.isMDXComponent=!0},99268:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/migrate-tables-fb16ddda016f80d566df1356207087f7.png"}}]);