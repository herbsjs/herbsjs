"use strict";(self.webpackChunkherbjs_website=self.webpackChunkherbjs_website||[]).push([[9857],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),p=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),m=i,k=u["".concat(l,".").concat(m)]||u[m]||c[m]||a;return n?r.createElement(k,o(o({ref:t},d),{},{components:n})):r.createElement(k,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,o=new Array(a);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var p=2;p<a;p++)o[p]=n[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},21562:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return c}});var r=n(87462),i=n(63366),a=(n(67294),n(3905)),o=["components"],s={id:"herbs2knex",title:"Knex - Herbs2Knex",sidebar_label:"Knex",slug:"/glues/Herbs2knex"},l=void 0,p={unversionedId:"glues/herbs2knex",id:"glues/herbs2knex",title:"Knex - Herbs2Knex",description:"Creates repositories to retrieve and store Entities using Knex, a relational database query builder for Node.js.",source:"@site/docs/glues/herbs2knex.md",sourceDirName:"glues",slug:"/glues/Herbs2knex",permalink:"/docs/glues/Herbs2knex",editUrl:"https://github.com/herbsjs/herbsjs.github.io/blob/master/docs/glues/herbs2knex.md",tags:[],version:"current",frontMatter:{id:"herbs2knex",title:"Knex - Herbs2Knex",sidebar_label:"Knex",slug:"/glues/Herbs2knex"},sidebar:"sidebar",previous:{title:"REST",permalink:"/docs/glues/herbs2rest"},next:{title:"Mongo",permalink:"/docs/glues/Herbs2mongo"}},d={},c=[{value:"Installing",id:"installing",level:3},{value:"Using",id:"using",level:3},{value:"What is a Repository?",id:"what-is-a-repository",level:3},{value:"Herbs2knex Repository",id:"herbs2knex-repository",level:3},{value:"Why Knex?",id:"why-knex",level:3},{value:"Repository setup",id:"repository-setup",level:3},{value:"Retrieving and Persisting Data",id:"retrieving-and-persisting-data",level:2},{value:"find",id:"find",level:3},{value:"findByID",id:"findbyid",level:3},{value:"insert",id:"insert",level:3},{value:"update",id:"update",level:3},{value:"delete",id:"delete",level:3},{value:"Conventions - Defaul implementation",id:"conventions---defaul-implementation",level:2},{value:"Fields",id:"fields",level:3},{value:"Object-Oriented versus Relational models - Relationships",id:"object-oriented-versus-relational-models---relationships",level:2}],u={toc:c};function m(e){var t=e.components,n=(0,i.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Creates repositories to retrieve and store ",(0,a.kt)("a",{parentName:"p",href:"/docs/entity/getting-started"},"Entities")," using ",(0,a.kt)("a",{parentName:"p",href:"http://knexjs.org"},"Knex"),", a relational database query builder for Node.js."),(0,a.kt)("h3",{id:"installing"},"Installing"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm install @herbsjs/herbs2knex\n")),(0,a.kt)("h3",{id:"using"},"Using"),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"connection.js")," - Knex initialization:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const knex = require('knex')\nconst config = require('./config')\nmodule.exports = knex(config)\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"itemRepository.js"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const { Repository } = require('@herbsjs/herbs2knex')\nconst connection = require('connection')\nconst { Item } = require('../domain/entities/item')\n\nclass ItemRepository extends Repository {\n    constructor() {\n        super({\n            entity: Item,\n            table: 'aTable',\n            ids: ['id'],\n            knex: connection\n        })\n    }\n\n    excludedItemFromLastWeek() {\n        ...\n    }\n}\n")),(0,a.kt)("p",null,(0,a.kt)("inlineCode",{parentName:"p"},"someUsecase.js"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository()\nconst ret = await repo.findByID(1)\n")),(0,a.kt)("h3",{id:"what-is-a-repository"},"What is a Repository?"),(0,a.kt)("p",null,"A repository, by ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Domain-driven_design#Building_blocks"},"definition"),", is part of the layer to retrieve and store entities abstracting the underlying implementation. By using repositories, details of these implementation such as relational database, document-oriented databases, etc., should not leak to the domain code. In other words, no raw SQL queries on your use case or entity files."),(0,a.kt)("h3",{id:"herbs2knex-repository"},"Herbs2knex Repository"),(0,a.kt)("p",null,"In order to boost productivity, Herbs2knex provides ways to dynamically generate, on the fly (no code generation), a repository class based on your Entities and other metadata. "),(0,a.kt)("p",null,"These metadata are necessary to close the gap between OOP concepts and paradigms and those of relational databases. For example, it is necessary to specify primary keys and foreign keys as these information do not exist in the description of your domain."),(0,a.kt)("p",null,"Following Herbs architecture principals, it is not the intention of this lib to create yet another ORM or query builder but to create a bridge between your domain and an existing one (Knex)."),(0,a.kt)("h3",{id:"why-knex"},"Why Knex?"),(0,a.kt)("p",null,"Herbs2knex is just one of many bridges possible between Herbs and other packages."),(0,a.kt)("p",null,"The advantage of using Knex is that is a simple and flexible SQL query builder. It also supports Postgres, MSSQL, MySQL, MariaDB, SQLite3, Oracle and Amazon Redshift. Therefore, you can build your system using these databases out of the box."),(0,a.kt)("h3",{id:"repository-setup"},"Repository setup"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const { Repository } = require('@herbsjs/herbs2knex')\nconst connection = require('connection')  // Knex initialize instance\nconst { ProductItem } = require('../domain/entities/productItem')\n\nclass YourRepository extends Repository {\n    constructor() {\n        super({\n            entity: ProductItem,\n            schema: 'main',\n            table: 'product_items',\n            ids: ['id'],\n            foreignKeys: [{ customerId: String }],\n            knex: connection\n        })\n    }\n}\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"entity")," - The ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/herbsjs/gotu"},"Entity")," to be used as reference "),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"entity: ProductItem\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"schema")," - The schema to be used  "),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"schema: 'production'\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"table")," - The name of the table in database"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"table: 'product_items'\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"ids")," - Primary keys"),(0,a.kt)("p",{parentName:"li"},"  Format: ",(0,a.kt)("inlineCode",{parentName:"p"},"['fieldName', 'fieldName', ...]")),(0,a.kt)("p",{parentName:"li"},"  There must be corresponding fields in the entity."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"ids: ['id']  // productItem.id\n")),(0,a.kt)("p",{parentName:"li"},"  or for composite primary key: "),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"ids: [`customerId`, `productId`]  // productItem.customerId , productItem.productId\n")),(0,a.kt)("p",{parentName:"li"},"  It is possible to omit the ",(0,a.kt)("inlineCode",{parentName:"p"},"ids")," property if the entity already has fields defined on it with ",(0,a.kt)("inlineCode",{parentName:"p"},"field")," and the ",(0,a.kt)("inlineCode",{parentName:"p"},"isId")," option or ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," helper functions:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// entity definition\nconst Order = entity('Order', {\n    orderSequence: field(Number, { isId: true }),\n    customerId: id(Number)\n})\n\n// repository definition\nclass OrderRepository extends Repository {\n    constructor({\n        entity: Order,\n        // same as ids: ['orderSequence', 'customerId']\n    })\n}\n\n"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"foreignKeys")," (optional) - Foreign keys for the database table"),(0,a.kt)("p",{parentName:"li"},"  Usually, there is no corresponding fields declared in the entity for foreign keys. That is the reason it is necessary to inform the name and the type of the fields."),(0,a.kt)("p",{parentName:"li"},"  Format: ",(0,a.kt)("inlineCode",{parentName:"p"},"[{ fieldName: Type }, { fieldName: Type }, ...]")),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"foreignKeys: [{ customerId: String }]\n")),(0,a.kt)("p",{parentName:"li"},"  The field names will te converted to a database names using conventions. Ex: ",(0,a.kt)("inlineCode",{parentName:"p"},"customer_id"))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},(0,a.kt)("inlineCode",{parentName:"p"},"knex")," - Knex initialize instance"),(0,a.kt)("p",{parentName:"li"},"  Check Knex ",(0,a.kt)("a",{parentName:"p",href:"http://knexjs.org/#Installation-client"},"documentation")))),(0,a.kt)("h2",{id:"retrieving-and-persisting-data"},"Retrieving and Persisting Data"),(0,a.kt)("h3",{id:"find"},"find"),(0,a.kt)("p",null,"Find entities matched by the filter, or empty array ",(0,a.kt)("inlineCode",{parentName:"p"},"[]")," if there is no matching entity."),(0,a.kt)("p",null,"Format: ",(0,a.kt)("inlineCode",{parentName:"p"},".find(options)")," where ",(0,a.kt)("inlineCode",{parentName:"p"},"options")," is a optional object containing ",(0,a.kt)("inlineCode",{parentName:"p"},"{ where, limit, offset, orderBy }")),(0,a.kt)("p",null,"Return: Entity array"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.find()\n")),(0,a.kt)("p",null,"Options:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"where"),"\nAdds a filter to the query with given values.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'const repo = new ItemRepository(injection)\nconst ret = await repo.find({ where: { name: ["Anne"] } })\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"limit"),"\nAdds a limit clause to the query.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.find({ limit: 10 })\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"offset"),"\nAdds an offset clause to the query.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.find({ offset: 5 })\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"orderBy"),"\nAdds an order by clause to the query. Column can be string, or list mixed with string and object.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// order by collum\nconst repo = new ItemRepository(injection)\nconst ret = await repo.find({ orderBy: 'description'})\n\n// order by complex query\nconst repo = new ItemRepository(injection)\nconst ret = await repo.find({ orderBy: [{ column: 'nome', order: 'desc' }, 'email'] })\n")),(0,a.kt)("h3",{id:"findbyid"},"findByID"),(0,a.kt)("p",null,"Find entities by IDs"),(0,a.kt)("p",null,"Format: ",(0,a.kt)("inlineCode",{parentName:"p"},".findByID(id)")," where ",(0,a.kt)("inlineCode",{parentName:"p"},"id")," is a value or an array."),(0,a.kt)("p",null,"Return: Entity array"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.findByID(10)\n")),(0,a.kt)("h3",{id:"insert"},"insert"),(0,a.kt)("p",null,"Insert an Entity into a table."),(0,a.kt)("p",null,"Format: ",(0,a.kt)("inlineCode",{parentName:"p"},".insert(entity)")," where ",(0,a.kt)("inlineCode",{parentName:"p"},"entity")," is a Entity instance with values to be persisted."),(0,a.kt)("p",null,"Return: The inserted entity with the values from database."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.insert(aNewEntity)\n")),(0,a.kt)("h3",{id:"update"},"update"),(0,a.kt)("p",null,"Update an Entity."),(0,a.kt)("p",null,"Format: ",(0,a.kt)("inlineCode",{parentName:"p"},".update(entity)")," where ",(0,a.kt)("inlineCode",{parentName:"p"},"entity")," is an Entity instance with values to be persisted."),(0,a.kt)("p",null,"Return: The updated entity with the values from database."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.update(aModifiedEntity)\n")),(0,a.kt)("h3",{id:"delete"},"delete"),(0,a.kt)("p",null,"Delete an Entity."),(0,a.kt)("p",null,"Format: ",(0,a.kt)("inlineCode",{parentName:"p"},".delete(entity)")," where ",(0,a.kt)("inlineCode",{parentName:"p"},"entity")," is an Entity instance to be deleted."),(0,a.kt)("p",null,"Return: ",(0,a.kt)("inlineCode",{parentName:"p"},"true")," for success or ",(0,a.kt)("inlineCode",{parentName:"p"},"false")," for error"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const repo = new ItemRepository(injection)\nconst ret = await repo.delete(entity)\n")),(0,a.kt)("h2",{id:"conventions---defaul-implementation"},"Conventions - Defaul implementation"),(0,a.kt)("h3",{id:"fields"},"Fields"),(0,a.kt)("p",null,"Code: Camel Case - ex: ",(0,a.kt)("inlineCode",{parentName:"p"},"productName")),(0,a.kt)("p",null,"Database: Snake Case - ex: ",(0,a.kt)("inlineCode",{parentName:"p"},"product_name")),(0,a.kt)("h2",{id:"object-oriented-versus-relational-models---relationships"},"Object-Oriented versus Relational models - Relationships"),(0,a.kt)("p",null,"An entity can define a reference for others entities but will not (and should not) define a foreign key. For instance:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"+------------------+         +------------------+         +------------------+\n|      Orders      |         |    OrderItems    |         |     Products     |\n+------------------+         +------------------+         +------------------+\n| id: int          |----\\    | id: int          |       --| id: int          |\n| customer_id: int |     ----| order_id: int    |  ----/  | name: string     |\n+------------------+         | product_id: int  |-/       +------------------+\n                            +------------------+                             \n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"const Product = entity('Product', {\n    id: id(Number),\n    name: field(String),\n    ...\n})\n\nconst OrderItem = entity('Order Items', {\n    id: id(Number),\n    product: field(Product),    // optional\n    ...\n})\n\nconst Order = entity('Order', {\n    id: id(Number),\n    item: field([OrderItem]),     // optional\n    ...\n})\n")),(0,a.kt)("p",null,"More about: ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Object%E2%80%93relational_impedance_mismatch"},"https://en.wikipedia.org/wiki/Object%E2%80%93relational_impedance_mismatch")))}m.isMDXComponent=!0}}]);